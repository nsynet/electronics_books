C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE DA1302
OBJECT MODULE PLACED IN da1302.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE da1302.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*============================================================
   2          使用1602液晶显示DS1302+c51时钟 
   3          [注:AT89C51使用12M晶振]
   4          =============================================================*/
   5          
   6          #include <AT89x51.h>
   7          #include <string.h>
   8          #include < intrins.h >
   9          #define delayNOP() ; {_nop_() ;_nop_() ;_nop_() ;_nop_() ;} ;
  10          #define LCM_RW P3_1 //定义引脚
  11          #define LCM_RS P3_0
  12          #define LCM_E P3_2
  13          #define LCM_Data P0
  14          #define Busy 0x80          //用于检测LCM状态字中的Busy标识
  15          #define uchar unsigned char
  16          
  17          sbit T_CLK=P2^4;
  18          sbit T_IO =P2^5;
  19          sbit T_RST=P2^6;
  20          sbit ACC0=ACC^0;
  21          sbit ACC7=ACC^7;
  22          sbit LED=P2^0;                   //背光灯输出 (因本实验板无此功能 所以此项功能无效)
  23          sbit system=P1^1;                //模式
  24          sbit TimerUp=P1^2;               //时间加
  25          sbit TimerDown=P1^0;     //时间减
  26          sbit Speaker=P2^1;       //蜂鸣器
  27          
  28          
  29          void   Set(uchar,uchar);      //根据选择调整相应项目
  30          void   RTInputByte(uchar);    //输入 1Byte */
  31          uchar  RTOutputByte(void);    //输出 1Byte */
  32          void   W1302(uchar, uchar);   //向DS1302写入一个字节
  33          uchar  R1302(uchar);          //从DS1302读出一个字节
  34          void   Set1302(uchar * );     //设置时间 
  35          void   KeySound();                        //按键音
  36          void   ClockSound();              //闹铃蜂鸣声
  37          
  38          
  39          uchar id,msec,model,LedTime,d;
  40          bit a,b;                          //闪烁标志位
  41          
  42                                  
  43          uchar inittime[7]={0x00,0x10,0x19,0x29,0x03,0x04,0x06}; //初始化后设置为：06年3月29日星期3 19点10分0秒
  44          void  Out_LCM(void);     //显示屏幕
  45          void  model0(void);                                                //显示输出
  46          void  model1(void);
  47          void  model2(void);
  48          void  model3(void);
  49          void  model4(void);
  50          void  model5(void);
  51          void  model6(void);
  52          
  53           
  54          void  id_case1_key();   //项目调整
  55          void  Modset();          //模式键处理
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 2   

  56          
  57          void  WriteDataLCM(uchar WDLCM);
  58          void  WriteCommandLCM(uchar WCLCM,BuysC);
  59          uchar ReadStatusLCM(void);
  60          void  LCMInit(void);
  61          void  OutputInformation(uchar X, uchar Y, uchar DData);
  62          void  DisplayListChar(uchar X, uchar Y, uchar code *DData);
  63          
  64          void  Delay5Ms(void);
  65          void  Delay400Ms(void);
  66          void  systemsetup(void);                 //进入系统设置
  67          
  68          uchar code systemp[]={"System.setup"};  //字符串输出(系统设定)
  69          uchar code TIMER[]={"Time"};            //字符串输出(时间)
  70          uchar code DATE[]={"Date"};                 //字符串输出(日期)
  71          uchar code alarmclock[]={"Clock"};      //字符串输出（闹铃）
  72          uchar code lamp[]={"Lamp"};                         //字符串输出（背光灯）
  73          uchar code reset[]={"Reset"};               //字符串输出（时间归零）
  74          uchar code exit[]={"Exit"};             //字符串输出（退出）
  75          uchar code set[]={"Set"};                               //字符串输出（设置）
  76          uchar code sec[]={"sec"};               //字符串输出（秒）
  77          uchar code ClockSet[]={"ClockSet"};             //字符串输出（闹铃设置）
  78          uchar code ClockOn[]={"ON"};                //字符串输出（ON）
  79          uchar code ClockOff[]={"OFF"};              //字符串输出（OFF）
  80          
  81          void  timesetup(void);                   //时间设置
  82          void  datesetup(void);                   //日期设置
  83          void  alarmclockset(void);               //闹铃设置
  84          void  lampsetup(void);                   //背光灯设置                                                                      
  85          void  timereset(void);                   //时间清零
  86          
  87          
  88          /*******************************************************************/
  89          void delay1(int ms)
  90          {
  91   1       unsigned char y ;
  92   1        while(ms--)
  93   1       {
  94   2        for(y = 0 ; y<250 ; y++)
  95   2        {
  96   3         _nop_() ;
  97   3         _nop_() ;
  98   3         _nop_() ;
  99   3         _nop_() ;
 100   3        }
 101   2       }
 102   1      }
 103          
 104          void main(void)
 105          {
 106   1        Speaker=1;    //关闭蜂鸣器
 107   1        LED=0;        //打开LED ,低电平有效，外接9012驱动
 108   1        Delay400Ms(); //启动等待，等LCM讲入工作状态
 109   1        Delay400Ms();
 110   1        LCMInit();    //LCM初始化
 111   1        TMOD=0x01;    //16位定时
 112   1        TH0=0x3c;             //50ms
 113   1        TL0=0xb0;
 114   1        EA=1;
 115   1        TR0=1;
 116   1        ET0=1;  
 117   1         
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 3   

 118   1        while(1)
 119   1        {
 120   2           if(TimerDown==0)         //左移键按下后把背光灯打开
 121   2            {Delay5Ms();
 122   3            if(TimerDown==0)
 123   3                 {KeySound();                   //蜂鸣声
 124   4                      LED=0;                            //打开背光灯
 125   4                  LedTime=R1302(0xc1)/16*10+R1302(0xc1)%16;} //取出背光灯时间并转换为十进制数         
 126   3             }
 127   2               b=1;                             //模式键是否动作标志。为1时不动作，为0时动作。
 128   2               Modset();                        //调用模式键处理程序判断按键是否按下。
 129   2               if(b==0)
 130   2                {
 131   3                 KeySound();                    //蜂鸣声
 132   3                 LED=0;                 //打开背光灯
 133   3                 systemsetup();         //进入系统设置模式
 134   3                 LedTime=R1302(0xc1)/16*10+R1302(0xc1)%16; //取出背光灯时间并转换为十进制数
 135   3                 }
 136   2               if((LED==0)&&LedTime==0)  //延时间是否到
 137   2                  LED=1;                 //关闭背光灯 
 138   2               if(R1302(0xc3)==1)        //闹铃是否打开，0xc3为读闹铃寄存器地址。
 139   2                 {if((R1302(0x85)==R1302(0xc5))&&(R1302(0x83)==R1302(0xc7))) //判断闹铃时间是否到，
 140   3                        ClockSound();            //发出闹铃蜂鸣声，无按键动作蜂鸣一分钟。
 141   3                      }          
 142   2               model0();                //输出显示屏幕
 143   2              }                                           
 144   1      }
 145          
 146          void KeySound()                         //按键音
 147          {
 148   1       Speaker=0;                                         //开蜂鸣声
 149   1       Delay5Ms();
 150   1       Speaker=1;                                         //关蜂鸣声
 151   1       }
 152          void ClockSound()                       //闹铃蜂鸣声
 153          {
 154   1       if(a==0)
 155   1        {
 156   2         Speaker=0;                                   //开蜂鸣声
 157   2         Delay5Ms();
 158   2         Delay5Ms();
 159   2         Delay5Ms();
 160   2         Speaker=1;                               //关蜂鸣声
 161   2        }
 162   1      }
 163          
 164          void Modset()                   //模式键处理
 165          { if(system==0)               
 166   1         {
 167   2          Delay5Ms();
 168   2          if(system==0)
 169   2               {while(system==0);
 170   3                 KeySound();                    //蜂鸣声
 171   3                 a=0;msec=0;b=0;                //a、msec为闪烁标志，按键有动作时清零，不闪烁。
 172   3               }                                                //b为模式键确认动作。其它程判断b是否为零时来确定模式键是否动作。
 173   2         }
 174   1      }
 175          
 176          void systemsetup(void)              //系统设置
 177          { 
 178   1        model=1;
 179   1        while(model!=0)
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 4   

 180   1        {     
 181   2        Out_LCM(); 
 182   2        if (TimerUp==0)             //设置项目左移
 183   2            {Delay5Ms();
 184   3             if(TimerUp==0)
 185   3                 {a=0;msec=0;KeySound();//蜂鸣声
 186   4                  if(model--==1)            //6种系统设置项目
 187   4                       model=6;
 188   4                      }   
 189   3             while(TimerUp==0);    
 190   3            }
 191   2         if (TimerDown==0)         //设置项目右移
 192   2            {
 193   3             Delay5Ms();
 194   3             if(TimerDown==0) 
 195   3                   {a=0;msec=0;KeySound();//蜂鸣声
 196   4                       if(model++==6)
 197   4                           model=1; 
 198   4                       }         
 199   3             while(TimerDown==0);    
 200   3            }
 201   2           b=1;                       //模式键是否动作标志。为1时不动作，为0时动作。
 202   2               Modset();              //调用模式键处理程序判断按键是否按下。
 203   2               if(b==0)
 204   2                 {KeySound();                    //蜂鸣声
 205   3                  switch(model)          //进入进个项目设置
 206   3                        {
 207   4                         case 1:
 208   4                              timesetup(); break;   //时间设置
 209   4                         case 2:
 210   4                              datesetup();break;    //日期设置
 211   4                         case 3:
 212   4                              alarmclockset();break;//闹铃设置
 213   4                         case 4:
 214   4                              lampsetup();break;        //背光灯设置
 215   4                     case 5:
 216   4                              timereset();break;    //时间清零
 217   4                         case 6:
 218   4                              model=0;break;        //退出系统设置
 219   4                        }
 220   3                }
 221   2         }
 222   1       }
 223          
 224                                                                    
 225          void timesetup()                //时间调整
 226          {
 227   1       id=6;
 228   1       while(model==1)                                //model为1时进入时间调整
 229   1        {
 230   2          b=1;
 231   2          Modset();
 232   2              if(b==0)
 233   2               {KeySound();                        //蜂鸣声
 234   3                if(id++==9)                       //6..9为时分秒调。                             .
 235   3                 id=6;
 236   3                }
 237   2         id_case1_key();                              //调用按键处理
 238   2         Out_LCM();                   //显示输出
 239   2       } 
 240   1      }
 241          void datesetup()                //对日期进行调整
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 5   

 242          {
 243   1       id=1;
 244   1       while(model==2)                                //model为2时进入日期调整
 245   1        {b=1;
 246   2         Modset();                                    //模式键是否动作
 247   2         if(b==0)
 248   2          {KeySound();                            //蜂鸣声
 249   3               if(id++==5)                        //1..5为年月日星期 exit
 250   3                id=1;
 251   3               }
 252   2       id_case1_key();                        //日期调整
 253   2       Out_LCM();                     //显示输出
 254   2       } 
 255   1      }
 256          void alarmclockset(void)            //闹铃调整
 257          {id=12;
 258   1       while(model==3)                            //进入闹铃设置
 259   1        {b=1;
 260   2         Modset();                                //模式键是否动作
 261   2         if(b==0)                                       
 262   2          {KeySound();                            //蜂鸣声
 263   3               if(R1302(0xc3)%16==0)
 264   3                 {id=0;model++;}          //0xc2为闹铃开关寄存器。当为关时按下模式键时将退出闹铃设置，当开时进入闹铃时
             -间设置
 265   3              
 266   3               else if(id++==15)                  //12..15为闹铃开关和时间设置 exit
 267   3                    id=12;
 268   3          }
 269   2        id_case1_key();                       //调整
 270   2        Out_LCM();                    //显示输出
 271   2        }
 272   1      } 
 273             
 274          void lampsetup(void)            //背光灯时间设置
 275          {id=10;                                                 //背光灯存储空间DS1302(0xc0)
 276   1        while(model==4)                               //model为3时进入背光灯调整
 277   1        {b=1;
 278   2         Modset();                                    //模式键是否动作
 279   2         if(b==0)
 280   2          {KeySound();                            //蜂鸣声
 281   3               if(id++==11)                       //10为背光灯 exit
 282   3                id=10;
 283   3               }
 284   2       id_case1_key();                        
 285   2       Out_LCM();                     //显示输出                    
 286   2       }
 287   1      
 288   1      }
 289          void  timereset()               //时间清零
 290          {
 291   1        Set1302(inittime);                //清时间
 292   1        W1302(0x90,0xa5);             //打开充电二级管  一个二级管串联一个2K电阻
 293   1        model++; 
 294   1      }
 295          //对相应的项目进行加、减调整。
 296          void id_case1_key()                             //按键处理
 297          {
 298   1        if (TimerUp==0)        //增加
 299   1            {
 300   2             Delay5Ms();
 301   2             if(TimerUp==0)
 302   2                  {a=0;msec=0;KeySound();                     //蜂鸣声
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 6   

 303   3                       if((id==9)||(id==5)||(id==11)||(id==15))       //当ID为9、5时按下加、减键将退出调整
 304   3                        { model++;                        //退出时间、日期设置
 305   4                          id=0;
 306   4                        }
 307   3                       else
 308   3                     Set(id,1);
 309   3                      }  
 310   2            while(TimerUp==0);    
 311   2           }
 312   1        if (TimerDown==0)  //减少
 313   1           {
 314   2             Delay5Ms();
 315   2             if(TimerDown==0) 
 316   2                  {a=0;msec=0;KeySound();                      //蜂鸣声
 317   3                       if((id==9)||(id==5)||(id==11)||(id==15))  //当ID为9、5时按下加、减键将退出调整
 318   3                        { model++;                         //退出时间、日期设置
 319   4                          id=0;
 320   4                        }
 321   3                 else
 322   3                         Set(id,0);             //调用DS1302写入函数
 323   3                 }          
 324   2            while(TimerDown==0);    
 325   2           }
 326   1      }
 327                           
 328          void timer_1(void) interrupt 1  //中断入口，闪烁
 329          {
 330   1        TH0=0x3c;            //50ms定时
 331   1        TL0=0xb0;
 332   1        if(msec++==10)           //500ms
 333   1         {msec=0;a=~a;       //闪烁标志反转 
 334   2              if(a==0)                   //1秒后背光时间减一秒。
 335   2               LedTime--;
 336   2         }  
 337   1      }
 338          
 339          //根据选择调整相应项目并写入DS1302
 340          void Set(uchar sel,uchar sel_1) 
 341          {
 342   1        uchar address,item;
 343   1        uchar max,min;
 344   1        if(sel==1)  {address=0x8c; max=99;min=0;}    //年
 345   1        if(sel==2)  {address=0x88; max=12;min=1;}    //月
 346   1        if(sel==3)  {address=0x86; max=31;min=1;}    //日
 347   1        if(sel==4)  {address=0x8a; max=7; min=1;}    //星期
 348   1        if(sel==6)  {address=0x84; max=23;min=0;}    //小时
 349   1        if(sel==7)  {address=0x82; max=59;min=0;}    //分钟
 350   1        if(sel==8)  {address=0x80; max=59;min=0;}    //秒
 351   1        if(sel==10) {address=0xc0; max=59;min=0;}    //背光时间，最长1分钟
 352   1        if(sel==12) {address=0xc2; max=1;min=0;}     //闹铃开关寄存器
 353   1        if(sel==13) {address=0xc4; max=23;min=0;}    //闹铃时寄存器
 354   1        if(sel==14) {address=0xc6; max=59;min=0;}    //闹铃分寄存器
 355   1      
 356   1      
 357   1        item=R1302(address+1)/16*10+R1302(address+1)%16;
 358   1        if (sel_1==0) item++;  else item--;
 359   1        if(item>max) item=min;   
 360   1        if(item<min) item=max;
 361   1                 
 362   1        W1302(0x8e,0x00);                   //允许写操作
 363   1        W1302(address,item/10*16+item%10);  //写入DS1302 //转成BCD码
 364   1        W1302(0x8e,0x80);                   //写保护，禁止写操作  
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 7   

 365   1      }
 366          
 367          //屏幕显示
 368          void Out_LCM(void) 
 369          { switch(model)
 370   1         {
 371   2          case 0: model0(); break;
 372   2              case 1: model1(); break;
 373   2              case 2: model2(); break;                   //在不同的条件下显示不同的字符
 374   2              case 3: model3(); break;
 375   2              case 4: model4(); break;
 376   2              case 5: model5(); break;
 377   2              case 6: model6(); break;
 378   2         }       
 379   1      }
 380          
 381          /***********************model为零时第一行显示时间，不为零时显示system setup******/
 382          void model0()
 383            {                                                                                                                             
 384   1         DisplayListChar(0,0,TIMER);   //显示固定字符串（Time)                                                
 385   1         OutputInformation(13,0,0x20); //不显示
 386   1         OutputInformation(4,0,0x20);  //不显示
 387   1         OutputInformation(4,1,0x20);  //不显示
 388   1         OutputInformation(15,1,0x20); //不显示
 389   1         OutputInformation(7,1,0x2f);  //显示固定字符 "/"
 390   1         OutputInformation(10,1,0x2f); //显示固定字符 "/"
 391   1         OutputInformation(13,1,0x2f); //显示固定字符 "/"
 392   1         DisplayListChar(0,1,DATE);    //显示固定字符串Date(日期）         
 393   1         if(a==1)                                      //冒号闪烁
 394   1          {OutputInformation(7,0,0x3a); OutputInformation(10,0,0x3a);}
 395   1         else
 396   1          {OutputInformation(7,0,0x20); OutputInformation(10,0,0x20);}
 397   1      
 398   1       /*******************model为零时第二行显示日期，不为零显示设置项目*******/
 399   1       
 400   1              OutputInformation(5,1,R1302(0x8d)/16+0x30);  //显示年
 401   1          OutputInformation(6,1,R1302(0x8d)%16+0x30);
 402   1       
 403   1          OutputInformation(8,1,R1302(0x89)/16+0x30);  //显示月 
 404   1          OutputInformation(9,1,R1302(0x89)%16+0x30);    
 405   1            
 406   1          OutputInformation(11,1,R1302(0x87)/16+0x30); //显示日
 407   1          OutputInformation(12,1,R1302(0x87)%16+0x30);    
 408   1      
 409   1          OutputInformation(14,1,R1302(0x8b)%16+0x30); //显示星期
 410   1      
 411   1          OutputInformation(5,0,R1302(0x85)/16+0x30);  //显示小时
 412   1          OutputInformation(6,0,R1302(0x85)%16+0x30); 
 413   1                 
 414   1          OutputInformation(8,0,R1302(0x83)/16+0x30);  //显示分钟
 415   1          OutputInformation(9,0,R1302(0x83)%16+0x30); 
 416   1                 
 417   1          OutputInformation(11,0,R1302(0x81)/16+0x30); //显示秒
 418   1          OutputInformation(12,0,R1302(0x81)%16+0x30); 
 419   1      }
 420            
 421          /*************************model不为零时显示系统设置***********************************/
 422          
 423          
 424                   
 425                                                                    //model为1时time闪烁，按下模式键后进入时间调整
 426          void model1()
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 8   

 427                   /*************************************判断ID的值来显示项目***********************/
 428          {        OutputInformation(0,0,0x20);          //不显示
 429   1           OutputInformation(1,0,0x20);
 430   1           DisplayListChar(2,0,systemp);         //第一行显示system setup
 431   1            if(id==0)                                                    //为0时显示TIME  date lalcak
 432   1                       {OutputInformation(9,1,0x20);     //不显示
 433   2                    OutputInformation(4,1,0x20);     //不显示
 434   2                        OutputInformation(15,1,0x20);    //不显示
 435   2                        DisplayListChar(5,1,DATE);       //显示date 
 436   2                        DisplayListChar(10,1,alarmclock);//显示lalcak
 437   2                                                                              
 438   2                        if(a==1)
 439   2                       {OutputInformation(0,1,0x20);     //不显示
 440   3                        OutputInformation(1,1,0x20);     //不显示
 441   3                            OutputInformation(2,1,0x20);     //不显示
 442   3                                OutputInformation(3,1,0x20);     //不显示
 443   3                           }
 444   2                    else                                                                                       
 445   2                      DisplayListChar(0,1,TIMER);       //显示time     
 446   2                       }
 447   1                else
 448   1                 {                                                                                         //id不为零进入时间调整项目
 449   2                         OutputInformation(3,1,0x3a);                  //显示固定字符 ":"
 450   2                 OutputInformation(6,1,0x3a);                  //显示固定字符 ":"
 451   2                 OutputInformation(9,1,0x20);                  //不显示
 452   2                         OutputInformation(10,1,0x20);                 //不显示
 453   2                         OutputInformation(0,1,0x20);                  //不显示
 454   2         /****************************时显示闪烁控制********************/
 455   2                         if((id==6)&&(a==1))                                           //id为5时时闪烁
 456   2                      {
 457   3                           OutputInformation(1,1,0x20); //不显示
 458   3                               OutputInformation(2,1,0x20); //不显示
 459   3                              }
 460   2                 else
 461   2                              {OutputInformation(1,1,R1302(0x85)/16+0x30); //显示时
 462   3                   OutputInformation(2,1,R1302(0x85)%16+0x30); 
 463   3                              }
 464   2        /******************************分显示闪烁控制********************/
 465   2                        if((id==7)&&(a==1))                                            //id为6时分闪烁
 466   2                      {
 467   3                           OutputInformation(4,1,0x20); //不显示
 468   3                               OutputInformation(5,1,0x20); //不显示
 469   3                              }
 470   2                        else
 471   2                               {OutputInformation(4,1,R1302(0x83)/16+0x30); //显示分
 472   3                    OutputInformation(5,1,R1302(0x83)%16+0x30); 
 473   3                               }
 474   2        /******************************秒显示闪烁控制********************/
 475   2                        if((id==8)&&(a==1))                                            //id为7时秒闪烁
 476   2                      {
 477   3                           OutputInformation(7,1,0x20); //不显示
 478   3                               OutputInformation(8,1,0x20); //不显示
 479   3                               }
 480   2                              else
 481   2                               {OutputInformation(7,1,R1302(0x81)/16+0x30); //显示秒
 482   3                    OutputInformation(8,1,R1302(0x81)%16+0x30); 
 483   3                               }
 484   2        /*******************************Exit显示闪烁控制********************/
 485   2      
 486   2                        if((id==9)&&(a==1))               //id为8时exit闪烁
 487   2                               {OutputInformation(11,1,0x20);     //不显示
 488   3                        OutputInformation(12,1,0x20);     //不显示
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 9   

 489   3                            OutputInformation(13,1,0x20);     //不显示
 490   3                                OutputInformation(14,1,0x20);     //不显示
 491   3                           }
 492   2                        else
 493   2                            DisplayListChar(11,1,exit);       //显示exit
 494   2                      }
 495   1      }
 496          /***************************************modelo为2时date闪烁***********************************************
             -/
 497          void model2()
 498          {
 499   1                if(id==0)
 500   1                 {OutputInformation(9,1,0x20);        //不显示
 501   2                  OutputInformation(4,1,0x20);        //不显示
 502   2                      OutputInformation(15,1,0x20);       //不显示
 503   2                      DisplayListChar(0,1,TIMER);             //显示time    
 504   2                  DisplayListChar(10,1,alarmclock);   //显示clock
 505   2                  if(a==1)
 506   2                       {OutputInformation(5,1,0x20);     //不显示
 507   3                    OutputInformation(6,1,0x20);     //不显示
 508   3                        OutputInformation(7,1,0x20);     //不显示
 509   3                        OutputInformation(8,1,0x20);     //不显示
 510   3                       }
 511   2                       
 512   2                 else
 513   2                   DisplayListChar(5,1,DATE);         //显示date
 514   2                 }
 515   1      /*****************************************************************************************************/
 516   1                                                              //id不为零时、进入日期调整
 517   1      /*****************************************************************************************************/
 518   1                else                                                          
 519   1                 { OutputInformation(0,1,0x20);                  //不显示
 520   2                       OutputInformation(11,1,0x20);                 //不显示
 521   2                   OutputInformation(3,1,0x2f);                  //显示固定字符 "/"
 522   2               OutputInformation(6,1,0x2f);                  //显示固定字符 "/"
 523   2               OutputInformation(9,1,0x2f);                  //显示固定字符 "/"  
 524   2         /****************************年显示闪烁控制********************/
 525   2                       if((id==1)&&(a==1))                                               //id为1时年闪烁
 526   2                    {
 527   3                         OutputInformation(1,1,0x20);                //不显示
 528   3                         OutputInformation(2,1,0x20);                //不显示
 529   3                        }
 530   2                       else
 531   2                        {OutputInformation(1,1,R1302(0x8d)/16+0x30); //显示年
 532   3                 OutputInformation(2,1,R1302(0x8d)%16+0x30); 
 533   3                        }
 534   2         /***************************月闪烁控制************************/
 535   2                       if((id==2)&&(a==1))                                               //id为2时月闪烁
 536   2                    {
 537   3                         OutputInformation(4,1,0x20);                //不显示
 538   3                         OutputInformation(5,1,0x20);                //不显示
 539   3                        }
 540   2                       else
 541   2                        {OutputInformation(4,1,R1302(0x89)/16+0x30); //显示月
 542   3                 OutputInformation(5,1,R1302(0x89)%16+0x30); 
 543   3                        }
 544   2        /***************************日闪烁控制************************/
 545   2                       if((id==3)&&(a==1))                                               //id为2日闪烁
 546   2                    {
 547   3                         OutputInformation(7,1,0x20);                //不显示
 548   3                         OutputInformation(8,1,0x20);                //不显示
 549   3                        }
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 10  

 550   2                       else
 551   2                        {OutputInformation(7,1,R1302(0x87)/16+0x30); //显示日
 552   3                 OutputInformation(8,1,R1302(0x87)%16+0x30); 
 553   3                        }
 554   2        /***************************星期闪烁控制*********************************/
 555   2                       if((id==4)&&(a==1))                                               //id为2时星期闪烁
 556   2                    {
 557   3                         OutputInformation(10,1,0x20);                //不显示
 558   3                        }
 559   2                       else
 560   2                        {OutputInformation(10,1,R1302(0x8b)%16+0x30); //显示星期
 561   3                        }
 562   2        /**************************exit闪烁控制*********************************/
 563   2                       if((id==5)&&(a==1))                                                //id为5时exit闪烁
 564   2                     { OutputInformation(12,1,0x20);     //不显示
 565   3                       OutputInformation(13,1,0x20);     //不显示
 566   3                           OutputInformation(14,1,0x20);     //不显示
 567   3                               OutputInformation(15,1,0x20);     //不显示
 568   3                           }
 569   2                       else
 570   2                         DisplayListChar(12,1,exit);                  //显示exit
 571   2                 }
 572   1      }
 573          /*********************************************************************************/
 574          
 575                                                                          /*model为3时进入闹铃项目
 576          
 577          /**********************************************************************************/
 578          void model3()
 579          {
 580   1            if(id==0) 
 581   1                 {OutputInformation(9,1,0x20);        //不显示
 582   2                  OutputInformation(4,1,0x20);        //不显示
 583   2                      OutputInformation(15,1,0x20);       //不显示
 584   2              DisplayListChar(0,1,TIMER);             //显示time 
 585   2                  DisplayListChar(5,1,DATE);          //显示date    
 586   2                  if(a==1)
 587   2                       { OutputInformation(10,1,0x20);     //不显示
 588   3                     OutputInformation(11,1,0x20);     //不显示
 589   3                         OutputInformation(12,1,0x20);     //不显示
 590   3                         OutputInformation(13,1,0x20);     //不显示
 591   3                         OutputInformation(14,1,0x20);
 592   3                       }
 593   2                  else
 594   2                   DisplayListChar(10,1,alarmclock);  //显示cloak
 595   2                 }
 596   1      
 597   1      /**************************id不为零进入闹铃设置显示********************/
 598   1               else
 599   1               {if(id==12)                                               //闹铃开关显示
 600   2                 {DisplayListChar(0,1,ClockSet);         //显示ClockSet
 601   3                      OutputInformation(8,1,0x20);
 602   3                      OutputInformation(13,1,0x20);
 603   3                      OutputInformation(14,1,0x20);
 604   3      /*****************************闹铃开关显示********************************/ 
 605   3                  if(a==1)                                                       //A为闪烁标志
 606   3                    {OutputInformation(10,1,0x20);     //不显示
 607   4                     OutputInformation(11,1,0x20);     //不显示
 608   4                         OutputInformation(12,1,0x20);     //不显示
 609   4                         OutputInformation(13,1,0x20);     //不显示
 610   4                        }     
 611   3                  else
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 11  

 612   3                   {
 613   4                    if(R1302(0xc3)%16==0)            //闹铃寄存器的值是否为零（关）
 614   4                              {DisplayListChar(10,1,ClockOff);}//显示OFF
 615   4                        else
 616   4                          {OutputInformation(9,1,0x20);    //不显示
 617   5                               OutputInformation(12,1,0x20);   //不显示
 618   5                       OutputInformation(13,1,0x20);   //不显示
 619   5                           OutputInformation(14,1,0x20);   //不显示
 620   5                               OutputInformation(15,1,0x20);   //不显示
 621   5                               DisplayListChar(10,1,ClockOn);  //显示ON 
 622   5                              }
 623   4                       }
 624   3                 }
 625   2               else 
 626   2                 {DisplayListChar(0,1,alarmclock);   //显示clock
 627   3                  OutputInformation(8,1,0x3a);       //显示固定字符 ":"
 628   3                      OutputInformation(5,1,0x20);       //不显示
 629   3                      OutputInformation(11,1,0x20);      //不显示
 630   3      /**************************闹铃时闪烁显示**********************/                 
 631   3                  if((id==13)&&(a==1))                           //闹铃时闪烁
 632   3                        {
 633   4                         OutputInformation(6,1,0x20);
 634   4                         OutputInformation(7,1,0x20);
 635   4                        }
 636   3                      else
 637   3                        {OutputInformation(6,1,R1302(0xc5)/16+0x30); //显示闹铃时
 638   4                         OutputInformation(7,1,R1302(0xc5)%16+0x30); //显示闹铃时
 639   4                        }
 640   3      
 641   3      /**************************闹铃分闪烁显示*******************/
 642   3                      if((id==14)&&(a==1))               //闹铃分闪烁
 643   3                       {OutputInformation(9,1,0x20);     //不显示
 644   4                        OutputInformation(10,1,0x20);    //不显示
 645   4                        
 646   4                       }
 647   3                      else
 648   3                        {OutputInformation(9,1,R1302(0xc7)/16+0x30);  //显示闹铃分
 649   4                         OutputInformation(10,1,R1302(0xc7)%16+0x30); //显示闹铃分
 650   4                        }
 651   3      
 652   3      /************************exit闪烁显示***********************/
 653   3                      if((id==15)&&(a==1))                       //exie闪烁
 654   3                        {OutputInformation(12,1,0x20);   //不显示
 655   4                     OutputInformation(13,1,0x20);   //不显示
 656   4                         OutputInformation(14,1,0x20);   //不显示
 657   4                         OutputInformation(15,1,0x20);   //不显示
 658   4                        }
 659   3                      else
 660   3                        DisplayListChar(12,1,exit);      //显示exit                                                              
 661   3                 }
 662   2               }
 663   1      }
 664                                                                  
 665          /*********************************背光灯设置*****************************************/
 666          void model4()
 667          {
 668   1                if(id==0)                                                             //id为零未进入背光灯设置
 669   1                 {OutputInformation(10,1,0x20);       //不显示
 670   2                  OutputInformation(11,1,0x20);       //不显示
 671   2                  OutputInformation(4,1,0x20);        //不显示
 672   2                      DisplayListChar(5,1,reset);         //显示reset         
 673   2                      DisplayListChar(12,1,exit);         //显示exit
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 12  

 674   2                      if(a==1)
 675   2                        {OutputInformation(0,1,0x20);     //不显示
 676   3                     OutputInformation(1,1,0x20);     //不显示
 677   3                         OutputInformation(2,1,0x20);     //不显示
 678   3                         OutputInformation(3,1,0x20);     //不显示
 679   3                         }
 680   2                      else
 681   2                DisplayListChar(0,1,lamp);        //显示lamp
 682   2                  }
 683   1               else                                                       //id不为零（10）进入背光灯时间设置
 684   1                 {DisplayListChar(0,1,lamp);          //显示lamp
 685   2                      DisplayListChar(4,1,set);           //显示set
 686   2                      DisplayListChar(9,1,sec);           //显示sec
 687   2                      DisplayListChar(12,1,exit);         //显示exit
 688   2                      if((id==10)&&(a==1))
 689   2                         {
 690   3                              OutputInformation(7,1,0x20);      //不显示               
 691   3                  OutputInformation(8,1,0x20);}
 692   2                      else
 693   2                        {
 694   3                         OutputInformation(7,1,R1302(0xc1)/16+0x30); //读出背光灯延时时间
 695   3                         OutputInformation(8,1,R1302(0xc1)%16+0x30);
 696   3                        }
 697   2                      if((id==11)&&(a==1))
 698   2                        {OutputInformation(12,1,0x20);     //不显示
 699   3                     OutputInformation(13,1,0x20);     //不显示
 700   3                         OutputInformation(14,1,0x20);     //不显示
 701   3                         OutputInformation(15,1,0x20);     //不显示
 702   3                        }
 703   2               }
 704   1      
 705   1      }
 706          /*********************************时间归零设置*****************************************/
 707          void model5()
 708          {       
 709   1              OutputInformation(4,1,0x20);        //不显示
 710   1                  OutputInformation(10,1,0x20);       //不显示
 711   1                      OutputInformation(11,1,0x20);       //不显示
 712   1                  DisplayListChar(0,1,lamp);          //显示lamp
 713   1                  DisplayListChar(12,1,exit);         //显示exit
 714   1                      if(a==1)
 715   1                       { OutputInformation(5,1,0x20);     //不显示
 716   2                     OutputInformation(6,1,0x20);     //不显示
 717   2                         OutputInformation(7,1,0x20);     //不显示
 718   2                         OutputInformation(8,1,0x20);     //不显示
 719   2                         OutputInformation(9,1,0x20);
 720   2                       }
 721   1                      else
 722   1                DisplayListChar(5,1,reset);       //显示reset   
 723   1      }
 724          /**********************************退出***********************************************/
 725          void model6()
 726          {
 727   1        OutputInformation(10,1,0x20);       //不显示
 728   1        OutputInformation(11,1,0x20);       //不显示
 729   1        DisplayListChar(0,1,lamp);          //显示lamp
 730   1        DisplayListChar(5,1,reset);         //显示reset
 731   1        if(a==1)
 732   1               {OutputInformation(12,1,0x20);   //不显示
 733   2                OutputInformation(13,1,0x20);   //不显示
 734   2                OutputInformation(14,1,0x20);   //不显示
 735   2                OutputInformation(15,1,0x20);   //不显示
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 13  

 736   2               }
 737   1        else
 738   1           DisplayListChar(12,1,exit);      //显示exit
 739   1      }
 740          
 741                  
 742            
 743          //********* LCM1602驱动程序 ***************
 744          //写数据
 745          void WriteDataLCM(uchar WDLCM)
 746          {
 747   1      ReadStatusLCM(); //检测忙
 748   1      
 749   1      LCM_RS = 1;
 750   1      LCM_RW = 0;
 751   1      LCM_E = 0; 
 752   1      LCM_Data = WDLCM;
 753   1      delayNOP() ;
 754   1          LCM_E = 1 ;
 755   1          delayNOP() ;
 756   1       LCM_E = 0 ; 
 757   1      }
 758          //写指令
 759          void WriteCommandLCM(uchar WCLCM,BuysC)     //BuysC为0时忽略忙检测
 760           {
 761   1        if (BuysC) ReadStatusLCM(); //根据需要检测忙
 762   1       
 763   1        LCM_RS = 0;
 764   1        LCM_RW = 0; 
 765   1        LCM_E = 0;
 766   1       _nop_() ;
 767   1          _nop_() ; 
 768   1       LCM_Data = WCLCM;
 769   1      delayNOP() ;
 770   1        LCM_E = 1; 
 771   1      delayNOP() ;
 772   1       LCM_E = 0;
 773   1       }
 774          //读状态
 775          uchar ReadStatusLCM(void)
 776           {
 777   1       LCM_RS = 0 ;
 778   1          LCM_RW = 1 ;
 779   1          LCM_E = 1 ;
 780   1          delayNOP() ;
 781   1        LCM_E = 1;
 782   1        while (LCM_Data & Busy); //检测忙信号
 783   1       LCM_E =0;
 784   1        return(LCM_Data);
 785   1       }
 786          //LCM初始化
 787          void LCMInit(void) 
 788           {
 789   1      
 790   1       
 791   1      
 792   1      delay1(15) ;
 793   1      
 794   1      WriteCommandLCM(0x01,1);
 795   1        WriteCommandLCM(0x38,1);
 796   1          delay1(5) ;
 797   1        WriteCommandLCM(0x38,1);
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 14  

 798   1        delay1(5) ;
 799   1        WriteCommandLCM(0x38,1);
 800   1        delay1(5) ;
 801   1        WriteCommandLCM(0x0c,1); //显示模式设置,开始要求每次检测忙信号
 802   1        delay1(5) ;
 803   1        WriteCommandLCM(0x06,1); // 显示光标移动设置
 804   1        
 805   1       }
 806          //按指定位置显示一个字符
 807          void OutputInformation(uchar X, uchar Y, uchar DData)
 808           {
 809   1        Y &= 0x1;
 810   1        X &= 0xF; //限制X不能大于15，Y不能大于1
 811   1        if (Y) X |= 0x40; //当要显示第二行时地址码+0x40;
 812   1        X |= 0x80; //算出指令码
 813   1        WriteCommandLCM(X, 0); //这里不检测忙信号，发送地址码
 814   1        WriteDataLCM(DData);
 815   1       }
 816          //按指定位置显示一串字符  ***原来的遇到空格0x20就不显示***
 817          void DisplayListChar(uchar X, uchar Y, uchar code *DData)
 818          {
 819   1        uchar ListLength,j;
 820   1        ListLength = strlen(DData);
 821   1        Y &= 0x1;
 822   1        X &= 0xF; //限制X不能大于15，Y不能大于1
 823   1            if (X <= 0xF) //X坐标应小于0xF
 824   1              { 
 825   2               for(j=0;j<ListLength;j++)
 826   2                  {
 827   3                   OutputInformation(X, Y, DData[j]); //显示单个字符
 828   3                   X++;
 829   3                  }
 830   2              }
 831   1      }
 832          //5ms延时
 833          void Delay5Ms(void)
 834           {
 835   1        unsigned int TempCyc = 5552;
 836   1        while(TempCyc--);
 837   1       }
 838          //400ms延时
 839          void Delay400Ms(void)
 840           {
 841   1        uchar TempCycA = 5;
 842   1        unsigned int TempCycB;
 843   1        while(TempCycA--)
 844   1        {
 845   2         TempCycB=7269;
 846   2         while(TempCycB--);
 847   2        }
 848   1       }
 849          
 850          //********DS1302读写程序***************//
 851          /******************************************************************** 
 852          函 数 名：RTInputByte()
 853          功    能：实时时钟写入一字节
 854          说    明：往DS1302写入1Byte数据 (内部函数)
 855          入口参数：d 写入的数据 
 856          返 回 值：无  
 857          ***********************************************************************/
 858          void RTInputByte(uchar d) 
 859          { 
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 15  

 860   1          uchar i;
 861   1          ACC = d;
 862   1          for(i=8; i>0; i--)
 863   1          {
 864   2              T_IO = ACC0;           /*相当于汇编中的 RRC */
 865   2              T_CLK = 1;
 866   2              T_CLK = 0;
 867   2              ACC = ACC >> 1; 
 868   2          } 
 869   1      }
 870          /******************************************************************** 
 871          函 数 名：RTOutputByte()
 872          功    能：实时时钟读取一字节
 873          说    明：从DS1302读取1Byte数据 (内部函数)
 874          入口参数：无  
 875          返 回 值：ACC
 876          设    计：zhaojunjie           日    期：2002-03-19
 877          修    改：                     日    期： 
 878          ***********************************************************************/
 879          uchar RTOutputByte(void) 
 880          { 
 881   1          uchar i;
 882   1          for(i=8; i>0; i--)
 883   1          {
 884   2              ACC = ACC >>1;         /*相当于汇编中的 RRC */
 885   2              ACC7 = T_IO;
 886   2              T_CLK = 1;
 887   2              T_CLK = 0;
 888   2          } 
 889   1          return(ACC); 
 890   1      }
 891          /******************************************************************** 
 892          函 数 名：W1302()
 893          功    能：往DS1302写入数据
 894          说    明：先写地址，后写命令/数据 (内部函数)
 895          调    用：RTInputByte() , RTOutputByte()
 896          入口参数：ucAddr: DS1302地址, ucData: 要写的数据
 897          返 回 值：无
 898          ***********************************************************************/
 899          void W1302(uchar ucAddr, uchar ucDa)
 900          {
 901   1          T_RST = 0;
 902   1          T_CLK = 0;
 903   1          T_RST = 1;
 904   1          RTInputByte(ucAddr);       /* 地址，命令 */
 905   1          RTInputByte(ucDa);       /* 写1Byte数据*/
 906   1          T_CLK = 1;
 907   1          T_RST = 0;
 908   1      }
 909          /******************************************************************** 
 910          函 数 名：R1302()
 911          功    能：读取DS1302某地址的数据
 912          说    明：先写地址，后读命令/数据 (内部函数)
 913          调    用：RTInputByte() , RTOutputByte()
 914          入口参数：ucAddr: DS1302地址
 915          返 回 值：ucData :读取的数据
 916          ***********************************************************************/
 917          uchar R1302(uchar ucAddr)
 918          {
 919   1          uchar ucData;
 920   1          T_RST = 0;
 921   1          T_CLK = 0;
C51 COMPILER V8.02   DA1302                                                                07/24/2009 13:21:30 PAGE 16  

 922   1          T_RST = 1;
 923   1          RTInputByte(ucAddr);             /* 地址，命令 */
 924   1          ucData = RTOutputByte();         /* 读1Byte数据 */
 925   1          T_CLK = 1;
 926   1          T_RST = 0;
 927   1          return(ucData);
 928   1      }
 929          
 930          /******************************************************************** 
 931          函 数 名：Set1302()
 932          功    能：设置初始时间
 933          说    明：先写地址，后读命令/数据(寄存器多字节方式)
 934          调    用：W1302()
 935          入口参数：pClock: 设置时钟数据地址 格式为: 秒 分 时 日 月 星期 年
 936                                         7Byte (BCD码)1B 1B 1B 1B 1B  1B  1B
 937          返 回 值：无
 938          ***********************************************************************/
 939          void Set1302(uchar *pClock) 
 940          {
 941   1          uchar i;
 942   1          uchar ucAddr = 0x80; 
 943   1          W1302(0x8e,0x00);           /* 控制命令,WP=0,写操作*/
 944   1          for(i =7; i>0; i--)
 945   1          { 
 946   2              W1302(ucAddr,*pClock);  /* 秒 分 时 日 月 星期 年 */ 
 947   2              pClock++;
 948   2              ucAddr +=2;
 949   2          }
 950   1          W1302(0x8e,0x80);           /* 控制命令,WP=1,写保护*/
 951   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3459    ----
   CONSTANT SIZE    =     69    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12      15
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
